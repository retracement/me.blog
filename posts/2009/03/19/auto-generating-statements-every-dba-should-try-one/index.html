<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="http://localhost:1313/favicon.ico" />
<meta property="og:url" content="http://localhost:1313/posts/2009/03/19/auto-generating-statements-every-dba-should-try-one/">
  <meta property="og:site_name" content="tenbulls blog">
  <meta property="og:title" content="Auto generate RESTORE scripts from a live database">
  <meta property="og:description" content="Have you ever performed a scripted restore or some of similar operation and then got entirely frustrated at the laborious and error prone nature of this exercise especially when the database consists of many datafiles and transaction log files?
Of course the SQL Server 2005 GUI is very good at making the restore process much easier but it’s biggest failing is that it doesn’t preserve filenames (especially when the restored database name is changed). This is a very big problem when you have a large number of data files and causes a big headache.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2009-03-19T02:13:49+01:00">
    <meta property="article:modified_time" content="2009-03-19T02:13:49+01:00">

<title>tenbulls blog | Auto generate RESTORE scripts from a live database</title>

    <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/palette/default.css">

      <script src="/js/main.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body
    class="dark"
>
  
  <main>
    
  <div class="container pt-5">
    <div class="row mt-5 pt-5">
      
  <nav aria-label="breadcrumb" class="small navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleMenu" aria-controls="collapsibleMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse mt-3 mt-md-0" id="collapsibleMenu">
      <ol class="breadcrumb fw-bold">
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/about"
        
      >about</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/"
        
      >home</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="https://www.meetup.com/hybrid-virtual-group/"
        
          target="_blank" rel="noopener noreferrer"
        
      >meetup</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/posts"
        class="text-decoration-underline link-offset-3"
        
      >posts</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/tags"
        
      >tags</a>
      
    </li>
      </ol>
    </div>
  </nav>

    </div>
    <div class="post">
      <header class="mb-4">
        <h1 class="text-uppercase">Auto generate RESTORE scripts from a live database</h1>
        
        
        <div aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item small">
              
              <time datetime="2009-03-19T02:13:49&#43;01:00">March 19, 2009</time>
            </li>
            
            
            <li class="breadcrumb-item small">
              2 minutes
            </li>
          </ol>
        </div>
      </header>
      
      <article>
        <p>Have you ever performed a scripted restore or some of similar operation and then got entirely frustrated at the laborious and error prone nature of this exercise especially when the database consists of many datafiles and transaction log files?</p>
<p>Of course the SQL Server 2005 GUI is very good at making the restore process much easier but it&rsquo;s biggest failing is that it doesn&rsquo;t preserve filenames (especially when the restored database name is changed). This is a very big problem when you have a large number of data files and causes a big headache.</p>
<p>My solution is to use TSQL to auto generate a restore script, and I have found this to work very well and is much faster and more flexible than the GUI approach. When performing operations such as setting up a database mirror (since this can be a more repetitive process AND it is fairly important to preserve file paths) this code really becomes quite useful.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--Ensure that connection is set to source database to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--generate restore script from
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>backupfilefull SYSNAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--set path to source database backup file
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>backupfilefull <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\backuppath\backupfile.bak&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@@</span>cmd VARCHAR(<span style="color:#ae81ff">4000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--generate restore statement
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@@</span>cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;RESTORE DATABASE &#39;</span> <span style="color:#f92672">+</span> db_name() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; FROM DISK = &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span> <span style="color:#f92672">@</span>backupfilefull <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;&#39; WITH STATS = 1, NORECOVERY&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>cmd <span style="color:#f92672">=</span> <span style="color:#f92672">@@</span>cmd <span style="color:#f92672">+</span> CHAR(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;,MOVE &#39;&#39;&#39;</span> <span style="color:#f92672">+</span> RTRIM(name) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;&#39; TO &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span> RTRIM(filename) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;&#39;&#39;</span> <span style="color:#66d9ef">FROM</span> sysfiles
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--output statement
</span></span></span><span style="display:flex;"><span>PRINT <span style="color:#f92672">@@</span>cmd
</span></span></code></pre></div><p>Running this under the context of the master database would generate the following script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>RESTORE <span style="color:#66d9ef">DATABASE</span> master <span style="color:#66d9ef">FROM</span> DISK <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\backuppath\backupfile.bak&#39;</span>  <span style="color:#66d9ef">WITH</span> STATS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, NORECOVERY
</span></span><span style="display:flex;"><span>,<span style="color:#66d9ef">MOVE</span> <span style="color:#e6db74">&#39;master&#39;</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;D:\sql2005\MSSQL.1\MSSQL\DATA\master.mdf&#39;</span>
</span></span><span style="display:flex;"><span>,<span style="color:#66d9ef">MOVE</span> <span style="color:#e6db74">&#39;mastlog&#39;</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;D:\sql2005\MSSQL.1\MSSQL\DATA\mastlog.ldf&#39;</span>
</span></span></code></pre></div><p>I have created similar auto generation scripts for creating database snapshots and various other things which makes life SO much easier. Hope you get the idea!</p>

      </article>
      

      <div class="row">
    <div class="col-md">
        
        <a href="http://localhost:1313/posts/2009/03/05/moving-sql-server-data-and-log-files-dont-detach/">
            <span>previous: </span>
            <span>How to move your SQL Data and Log files correctly!</span>
        </a>
        
    </div>
    <div class="col-md text-md-end">
        
        <a href="http://localhost:1313/posts/2009/03/31/login-failures-for-windows-based-authentication-what-does-that-error-mean/">
            <span>next: </span>
            <span>Login failure user is not associated with a trusted SQL Server connection</span>
        </a>
        
    </div>
</div>
      
    </div>
  </div>
  <footer>
    <div class="container mt-4 pb-1">
    <p class="small opacity-75">
        Copyright © 2026 Mark Broadbent
        
    </p>
</div>

  </footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
