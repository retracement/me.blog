<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="http://localhost:1313/favicon.ico" />
<meta property="og:url" content="http://localhost:1313/posts/2013/07/17/why-dont-you-go-and-lock-off/">
  <meta property="og:site_name" content="tenbulls blog">
  <meta property="og:title" content="Why don‚Äôt you go and LOCK OFF!">
  <meta property="og:description" content="No this is not a Hekaton post üôÇ -perhaps I should have saved this title for another rainy day.
SQL Server concurrency is a particularly difficult subject to master and understanding the result of your actions can be confounded by some of SQL Server‚Äôs special behaviors and quirks that I so often like to talk and write about.
As some of my followers stalkers out there may remember, one of my favorite demonstrations I like to give is during my READPAST &amp; Furious: Transactions, Locking, and Isolation session -last performed at the SQLPASS 2012 Summit and SQLSaturday #229 Dublin where in a little piece of code I discuss whether a transaction is really Atomic (or not). For anyone reading this paragraph who has immediately answered ‚ÄúALWAYS‚Äù -then my friend you are in serious trouble with your code-base. And I am not even talking about the use of lower levels of isolation to perform dirty reads within your transaction here, isolation does not effect a transaction‚Äôs atomicity.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2013-07-17T13:44:00+01:00">
    <meta property="article:modified_time" content="2013-07-17T13:44:00+01:00">
    <meta property="article:tag" content="Concurrency">
    <meta property="article:tag" content="SQL">

<title>tenbulls blog | Why don‚Äôt you go and LOCK OFF!</title>

    <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/palette/default.css">

      <script src="/js/main.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body
    class="dark"
>
  
  <main>
    
  <div class="container pt-5">
    <div class="row mt-5 pt-5">
      
  <nav aria-label="breadcrumb" class="small navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleMenu" aria-controls="collapsibleMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse mt-3 mt-md-0" id="collapsibleMenu">
      <ol class="breadcrumb fw-bold">
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/about"
        
      >about</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/"
        
      >home</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="https://www.meetup.com/hybrid-virtual-group/"
        
          target="_blank" rel="noopener noreferrer"
        
      >meetup</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/posts"
        class="text-decoration-underline link-offset-3"
        
      >posts</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/tags"
        
      >tags</a>
      
    </li>
      </ol>
    </div>
  </nav>

    </div>
    <div class="post">
      <header class="mb-4">
        <h1 class="text-uppercase">Why don‚Äôt you go and LOCK OFF!</h1>
        
        
        <div aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item small">
              
              <time datetime="2013-07-17T13:44:00&#43;01:00">July 17, 2013</time>
            </li>
            
            
            <li class="breadcrumb-item small">
              4 minutes
            </li>
          </ol>
        </div>
      </header>
      
      <article>
        <p>No this is not a Hekaton post üôÇ -perhaps I should have saved this title for another rainy day.</p>
<p>SQL Server concurrency is a particularly difficult subject to master and understanding the result of your actions can be confounded by some of SQL Server‚Äôs special behaviors and quirks that I so often like to talk and write about.</p>
<p>As some of my <del>followers</del> stalkers out there may remember, one of my favorite demonstrations I like to give is during my
<a href="https://www.sqlpass.org/summit/2012/Sessions/SessionDetails.aspx?sid=2816">READPAST &amp; Furious: Transactions, Locking, and Isolation</a> session -last performed at the <a href="https://www.sqlpass.org/summit/2012/">SQLPASS 2012 Summit</a> and <a href="https://www.sqlsaturday.com/viewsession.aspx?sat=229&amp;sessionid=14975">SQLSaturday #229 Dublin</a> where in a little piece of code I discuss whether a transaction is really Atomic (or not). For anyone reading this paragraph who has immediately answered ‚ÄúALWAYS‚Äù -then my friend you are in serious trouble with your code-base. And I am not even talking about the use of lower levels of isolation to perform dirty reads within your transaction here, isolation does not effect a transaction‚Äôs atomicity.</p>
<p>No, what I am talking about how SQL Server (under certain conditions) can fail a statement in a transaction, but still successfully commit. If this is not the behavior that was intended for your application then congratulations! You now have an inconsistent dataset. You can read a quite exhaustive post on this subject from my post <a href="/posts/2012/10/23/baby-baby-baby-where-did-our-love-data-go">Baby baby baby, where did our ROLLBACK go?</a>.</p>
<p><img src="/images/2013/craplock.jpg" alt="bad lock"></p>
<p>Yesterday I was talking with a colleague (and fellow speaker) about a particularly bad concurrency issue at our current place of work and he told me that one quick and dirty proposal was to limit the duration of problematic locks, it had been suggested to set the <code>LOCK_TIMEOUT</code> for each session. Straight away, my alarm bells started ringing and I replied that this is probably a very bad idea. I could talk for hours on why it is a bad idea from a concurrency perspective -it is a bit like asking someone to attempt to cross a busy road and return to the Kerb (Sidewalk for my American buddies!) each time if a car is coming. However I won‚Äôt bore you with that detail, I will simply say that once you have read my post (referenced above) I will add that one such behavior (that allows the failure of a statement but does not cause a rollback) is using the LOCK_TIMEOUT session setting. Oh yes I know a lot of you out there are using it, and yes you had better start praying üôÇ</p>
<p>In the following code snippet we demonstrate this behavior by updating one record in a table in an open ended transaction (which will take an Exclusive lock on this row). In a second connection we will run a second transaction in a session using a LOCK_TIMEOUT that first inserts a record into this table and then attempts to delete our locked record (and triggering the lock timeout).</p>
<p>Let‚Äôs first create a table with a single record and exclusively lock that record out under an open ended transaction:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--connection 1
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> t1 (c1 INT)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> t1 <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;1&#39;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--update value in open ended
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">--transaction to take exclusive
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">--lock where c1=1
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UPDATE</span> t1 <span style="color:#66d9ef">SET</span> c1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">WHERE</span> c1<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Next we will run a transaction in another connection to insert one record into this table and attempt to remove the blocked record:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--connection 2
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> LOCK_TIMEOUT <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> t1 <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;2&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> t1 <span style="color:#66d9ef">WHERE</span> c1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">COMMIT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--after lock timeout view committed values
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> t1 <span style="color:#66d9ef">WITH</span> (READPAST);
</span></span></code></pre></div><p>The following error occurs‚Ä¶</p>
<blockquote>
<p>(1 row(s) affected)
Msg 1222, Level 16, State 45, Line 5
Lock request time out period exceeded.
The statement has been terminated.</p>
<p>(1 row(s) affected)</p>
</blockquote>
<p>Now you can quite clearly see that the LOCK_TIMEOUT worked, but let us now take a look at the committed contents of the table (skipping over the locked record using the <code>READPAST</code> hint):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--connection 2
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> t1 <span style="color:#66d9ef">WITH</span> (READPAST);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>c1
</span></span><span style="display:flex;"><span>‚Äî‚Äî‚Äî‚Äì
</span></span><span style="display:flex;"><span>2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(1 row(s) affected)
</span></span></code></pre></div><p>Yes transaction fans you will see that the row we inserted under an <em>Atomic</em> transaction committed successfully whilst the delete failed. I am not going to labour this point any more than to say, please be careful to understand any setting you enable for concurrency optimization and troubleshooting. If you are not careful, then you may live to regret it!</p>

      </article>
      
  <div class="tags pb-4 pt-2">
    
    
        <a class="badge rounded-pill text-uppercase text-bg-secondary" href="/tags/concurrency/">Concurrency</a>
        <a class="badge rounded-pill text-uppercase text-bg-secondary" href="/tags/sql/">SQL</a>
  </div>

      <div class="row">
    <div class="col-md">
        
        <a href="http://localhost:1313/posts/2013/06/06/countdown-to-sqlsaturday-edinburgh/">
            <span>previous: </span>
            <span>Countdown to SQLSaturday Edinburgh</span>
        </a>
        
    </div>
    <div class="col-md text-md-end">
        
        <a href="http://localhost:1313/posts/2013/09/25/change-your-event-and-make-a-difference/">
            <span>next: </span>
            <span>Change (your event) and make a difference!</span>
        </a>
        
    </div>
</div>
      
    </div>
  </div>
  <footer>
    <div class="container mt-4 pb-1">
    <p class="small opacity-75">
        Copyright ¬© 2026 Mark Broadbent
        
    </p>
</div>

  </footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
