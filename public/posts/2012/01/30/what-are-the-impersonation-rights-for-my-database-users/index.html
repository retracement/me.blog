<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="http://localhost:1313/favicon.ico" />
<meta property="og:url" content="http://localhost:1313/posts/2012/01/30/what-are-the-impersonation-rights-for-my-database-users/">
  <meta property="og:site_name" content="tenbulls blog">
  <meta property="og:title" content="What are the impersonation rights for my database users?">
  <meta property="og:description" content="From time to time I get thrown the odd request to provide various bits of information from the SQL Server environment and most recently I was asked about a group of databases that required migrating to another instance. For some reason there had been a little bit of a panic about the impersonation rights in each of the databases and their configuration. The request was *ahem* kindly passed to me. The number of database users was huge in each database and performing a manual lookup through the SSMS GUI got rather tiresome very quickly (after about the second user).">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2012-01-30T14:29:00+01:00">
    <meta property="article:modified_time" content="2012-01-30T14:29:00+01:00">
    <meta property="article:tag" content="SQL">
    <meta property="article:tag" content="Security">

<title>tenbulls blog | What are the impersonation rights for my database users?</title>

    <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/palette/default.css">

      <script src="/js/main.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body
    class="dark"
>
  
  <main>
    
  <div class="container pt-5">
    <div class="row mt-5 pt-5">
      
  <nav aria-label="breadcrumb" class="small navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleMenu" aria-controls="collapsibleMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse mt-3 mt-md-0" id="collapsibleMenu">
      <ol class="breadcrumb fw-bold">
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/about"
        
      >about</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/"
        
      >home</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="https://www.meetup.com/hybrid-virtual-group/"
        
          target="_blank" rel="noopener noreferrer"
        
      >meetup</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/posts"
        class="text-decoration-underline link-offset-3"
        
      >posts</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/tags"
        
      >tags</a>
      
    </li>
      </ol>
    </div>
  </nav>

    </div>
    <div class="post">
      <header class="mb-4">
        <h1 class="text-uppercase">What are the impersonation rights for my database users?</h1>
        
        
        <div aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item small">
              
              <time datetime="2012-01-30T14:29:00&#43;01:00">January 30, 2012</time>
            </li>
            
            
            <li class="breadcrumb-item small">
              4 minutes
            </li>
          </ol>
        </div>
      </header>
      
      <article>
        <p>From time to time I get thrown the odd request to provide various bits of information from the SQL Server environment and most recently I was asked about a group of databases that required migrating to another instance. For some reason there had been a little bit of a panic about the impersonation rights in each of the databases and their configuration. The request was <em>*ahem*</em> kindly passed to me. The number of database users was huge in each database and performing a manual lookup through the SSMS GUI got rather tiresome very quickly (after about the second user).</p>
<p>My reply was that as long as we ensured each database was migrated with associated logins and mapped correctly (to prevent orphaned users) we didn’t really need to worry about the impersonation, since it would be contained within the databases and unaffected by the move. Unfortunately, there was no getting away from it, they still wanted a report.</p>
<p>I first decided to perform a web search for the term <em>list impersonate rights</em> which led my to quite a useful post by Kendal Van Dyke (<a href="https://www.kendalvandyke.com/">blog</a>|<a href="https://twitter.com/SQLDBA">twitter</a>) called <a href="https://www.kendalvandyke.com/2008/12/hey-mr-dba-what-permissions-do-i-have.html">Hey Mr. DBA, What Permissions Do I Have On This Database?</a> but I was already familiar with the examples listed, having previously come across the <a href="https://msdn.microsoft.com/en-us/library/ms176097.aspx">fn_my_permissions</a> and <a href="https://msdn.microsoft.com/en-us/library/ms186234.aspx">fn_builtin_permissions</a> functions in <a href="https://msdn.microsoft.com/en-us/library/ms130214.aspx">Books Online</a>. They did what I wanted, but really the wrong way around. To use them I would have to write a cursor based solution which would be a little long winded.</p>
<p>Thankfully most SQL Server problems are relatively easy to solve by applying a very small amount of grey matter to them. I decided to turn my attention to the system catalog views and started off with <a href="https://msdn.microsoft.com/en-us/library/ms187328.aspx">sys.database_principals</a>. Using the <a href="https://www.microsoft.com/download/en/details.aspx?id=722">Microsoft SQL Server 2008 R2 System Views poster</a> which is helpfully stuck to my office wall I focused in on this view and my attention was drawn to the <a href="https://msdn.microsoft.com/en-us/library/ms188367.aspx">sys.database_permissions</a> catalog directly underneath. Surely this would be the most likely candidate for the <code>IMPERSONATE</code> grants?</p>
<p><img src="/images/2012/dbprincipals.jpg" alt="Principals"><br/>
<em>Wall posters can come in handy!</em></p>
<p>After a very quick query of several of the databases provided to me I noticed that in one of them under the column <em>permission_name</em>, several rows contained the entry <em>IMPERSONATE</em> with a <em>state_desc</em> of <em>GRANT</em>. Bingo! That was just what I wanted. Time to write the query&hellip;</p>
<p>So we can test the query, let us first create a new database, several logins, several users from the logins and grant impersonation rights to some of the users to some of the others:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> Impersonation;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>USE Impersonation;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> LOGIN login1 <span style="color:#66d9ef">WITH</span> PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Password1&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> LOGIN login2 <span style="color:#66d9ef">WITH</span> PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Password2&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> LOGIN login3 <span style="color:#66d9ef">WITH</span> PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Password3&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> LOGIN login4 <span style="color:#66d9ef">WITH</span> PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Password4&#39;</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> user1 <span style="color:#66d9ef">FROM</span> LOGIN login1;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> user2 <span style="color:#66d9ef">FROM</span> LOGIN login2;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> user3 <span style="color:#66d9ef">FROM</span> LOGIN login3;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> user4 <span style="color:#66d9ef">FROM</span> LOGIN login4;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> IMPERSONATE <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">USER</span>::user4 <span style="color:#66d9ef">TO</span> user1;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> IMPERSONATE <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">USER</span>::user4 <span style="color:#66d9ef">TO</span> user2;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> IMPERSONATE <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">USER</span>::user1 <span style="color:#66d9ef">TO</span> user3;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> IMPERSONATE <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">USER</span>::user1 <span style="color:#66d9ef">TO</span> user2;
</span></span></code></pre></div><p>Next we should connect under login1 and change context to our Impersonation database; then attempt to impersonate <em>user4</em> to test that everything works:</p>
<p><img src="/images/2012/sqlcmd.jpg" alt="Impersonation"><br/>
<em>user4 impersonation works</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE Impersonation
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">USER</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user4&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> USER_NAME();
</span></span></code></pre></div><p>OK so we know all this works and we know how the rights are assigned. Lets write our query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE Impersonation
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> DB_NAME() <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">&#39;database&#39;</span>
</span></span><span style="display:flex;"><span>    ,pe.permission_name
</span></span><span style="display:flex;"><span>    ,pe.state_desc
</span></span><span style="display:flex;"><span>    ,pr.name <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">&#39;grantee&#39;</span>
</span></span><span style="display:flex;"><span>    ,pr2.name <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">&#39;grantor&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> sys.database_permissions pe
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">JOIN</span> sys.database_principals pr
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">ON</span> pe.grantee_principal_id <span style="color:#f92672">=</span> pr.principal_Id
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">JOIN</span> sys.database_principals pr2
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">ON</span> pe.grantor_principal_id <span style="color:#f92672">=</span> pr2.principal_Id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> pe.<span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;IM&#39;</span>
</span></span></code></pre></div><p>This query produces a rather simple result set as you see in the next picture:
<img src="/images/2012/impersonation.jpg" alt="impersonation results"></p>
<p>And there we have it -all impersonation rights are listed for the database in question. I was able to go onto query the five databases in question and provide a very simple report which would have taken me a very long time to perform using the SSMS GUI.</p>
<p>Whilst nothing I have demonstrated in this article is particularly difficult, it does highlight the multitude of different ways to perform operations in SQL Server. Just make sure you choose the easiest route!</p>

      </article>
      
  <div class="tags pb-4 pt-2">
    
    
        <a class="badge rounded-pill text-uppercase text-bg-secondary" href="/tags/sql/">SQL</a>
        <a class="badge rounded-pill text-uppercase text-bg-secondary" href="/tags/security/">Security</a>
  </div>

      <div class="row">
    <div class="col-md">
        
        <a href="http://localhost:1313/posts/2012/01/25/sqlrally-and-beyond/">
            <span>previous: </span>
            <span>SQLRally and Beyond</span>
        </a>
        
    </div>
    <div class="col-md text-md-end">
        
        <a href="http://localhost:1313/posts/2012/02/16/i-can-speak-english-i-learn-it-from-a-book/">
            <span>next: </span>
            <span>24 Hours Of PASS goes multi-lingual</span>
        </a>
        
    </div>
</div>
      
    </div>
  </div>
  <footer>
    <div class="container mt-4 pb-1">
    <p class="small opacity-75">
        Copyright © 2026 Mark Broadbent
        
    </p>
</div>

  </footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
