<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="http://localhost:1313/favicon.ico" />
<meta property="og:url" content="http://localhost:1313/posts/2009/05/27/simplifying-killing-spids-because-you-really-ought-to/">
  <meta property="og:site_name" content="tenbulls blog">
  <meta property="og:title" content="Recursive killing of SPIDs in a database for admin operations">
  <meta property="og:description" content="One problem that I have found particulary annoying of late when performing any database operation that requires connections to it to be disconnected, such as setting it offline or a restoring over the top of itself is getting rid of these connections. Obviously this can be achieved by listing the current spids connected to the database and performing a kill for each spid. This can be quite laborious and obvious does not address any spids coming live whilst you are busy killing the existing ones, so you can end up going around in circles.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2009-05-27T02:11:18+01:00">
    <meta property="article:modified_time" content="2009-05-27T02:11:18+01:00">

<title>tenbulls blog | Recursive killing of SPIDs in a database for admin operations</title>

    <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/palette/default.css">

      <script src="/js/main.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body
    class="dark"
>
  
  <main>
    
  <div class="container pt-5">
    <div class="row mt-5 pt-5">
      
  <nav aria-label="breadcrumb" class="small navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleMenu" aria-controls="collapsibleMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse mt-3 mt-md-0" id="collapsibleMenu">
      <ol class="breadcrumb fw-bold">
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/about"
        
      >about</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/"
        
      >home</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="https://www.meetup.com/hybrid-virtual-group/"
        
          target="_blank" rel="noopener noreferrer"
        
      >meetup</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/posts"
        class="text-decoration-underline link-offset-3"
        
      >posts</a>
      
    </li>
      </ol>
    </div>
  </nav>

    </div>
    <div class="post">
      <header class="mb-4">
        <h1 class="text-uppercase">Recursive killing of SPIDs in a database for admin operations</h1>
        
        
        <div aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item small">
              
              <time datetime="2009-05-27T02:11:18&#43;01:00">May 27, 2009</time>
            </li>
            
            
            <li class="breadcrumb-item small">
              3 minutes
            </li>
          </ol>
        </div>
      </header>
      
      <article>
        <p>One problem that I have found particulary annoying of late when performing any database operation that requires connections to it to be disconnected, such as setting it offline or a restoring over the top of itself is getting rid of these connections. Obviously this can be achieved by listing the current spids connected to the database and performing a kill for each spid. This can be quite laborious and obvious does not address any spids coming live whilst you are busy killing the existing ones, so you can end up going around in circles.</p>
<p>My solution to this is a script to effectively automate this manual process so that whilst the <code>SET OFFLINE</code> or <code>RESTORE</code> operation or such like are ticking away the procedure can be run specifying the name of the database and hey presto all live connections to this database are killed off one by one. The clever part (imo) to this script is the way in which it doesn’t attempt to block kill a batch of spids at the same time which might not be desirable should one of these spids close and be reused, but instead takes the first spid in the list and kills that and so on until no more spids are active for the specified database.</p>
<p>Obviously it is possible when altering a database to specify the option <code>WITH ROLLBACK IMMEDIATE</code> which has the same effect, but this option is not available for every situation and operation.</p>
<p>Anyway here is the stored procedure main body:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">@</span>dbname sysname, <span style="color:#75715e">--required option (the database from which to kill of any connected user based spids)
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">@</span>help bit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e">--optional option (view help)
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">IF</span> <span style="color:#f92672">@</span>dbname <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> name <span style="color:#66d9ef">FROM</span> master..sysdatabases) <span style="color:#66d9ef">AND</span> LEN(<span style="color:#f92672">@</span>dbname) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#f92672">@</span>dbname <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; database specified cannot be found.&#39;</span>
</span></span><span style="display:flex;"><span>PRINT 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RETURN</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">LOWER</span>(<span style="color:#f92672">@</span>dbname) <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;master&#39;</span>,<span style="color:#e6db74">&#39;tempdb&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#f92672">@</span>dbname <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;invalid operation on database &#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">@</span>dbname <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; specify different database.&#39;</span>
</span></span><span style="display:flex;"><span>PRINT 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RETURN</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>spid SMALLINT
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>str VARCHAR(<span style="color:#ae81ff">255</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--just select the last spid and kill it and loop around until no more spids
</span></span></span><span style="display:flex;"><span>PRINT <span style="color:#e6db74">&#39;Killing user processes in database &#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">@</span>dbname
</span></span><span style="display:flex;"><span>PRINT <span style="color:#e6db74">&#39;Executing from SPID &#39;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">CONVERT</span>(VARCHAR,<span style="color:#f92672">@@</span>SPID)
</span></span><span style="display:flex;"><span>WHILE <span style="color:#66d9ef">EXISTS</span>(<span style="color:#66d9ef">SELECT</span> TOP <span style="color:#ae81ff">1</span> spid <span style="color:#66d9ef">FROM</span> master..sysprocesses <span style="color:#66d9ef">WHERE</span> dbid <span style="color:#f92672">=</span> DB_ID(<span style="color:#f92672">@</span>dbname) <span style="color:#66d9ef">and</span> spid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">50</span> <span style="color:#66d9ef">and</span> spid <span style="color:#f92672">@@</span>SPID) <span style="color:#75715e">--user spids are 51 and higher
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> TOP <span style="color:#ae81ff">1</span> <span style="color:#f92672">@</span>spid <span style="color:#f92672">=</span> spid
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> master..sysprocesses
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> dbid <span style="color:#f92672">=</span> DB_ID(<span style="color:#f92672">@</span>dbname) <span style="color:#66d9ef">and</span> spid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">50</span> <span style="color:#66d9ef">and</span> spid <span style="color:#f92672">@@</span>SPID <span style="color:#75715e">--user spids are 51 and higher
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;KILL &#39;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">CONVERT</span>(VARCHAR, <span style="color:#f92672">@</span>spid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#f92672">@</span>str;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span>(<span style="color:#f92672">@</span>str)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#e6db74">&#39;Complete.&#39;</span>
</span></span></code></pre></div>
      </article>
      

      <div class="row">
    <div class="col-md">
        
        <a href="http://localhost:1313/posts/2009/03/31/login-failures-for-windows-based-authentication-what-does-that-error-mean/">
            <span>previous: </span>
            <span>Login failure user is not associated with a trusted SQL Server connection</span>
        </a>
        
    </div>
    <div class="col-md text-md-end">
        
        <a href="http://localhost:1313/posts/2009/06/09/copy-only-backups-another-great-addition/">
            <span>next: </span>
            <span>Preserve backup chain with COPY ONLY backups</span>
        </a>
        
    </div>
</div>
      
    </div>
  </div>
  <footer>
    <div class="container mt-4 pb-1">
    <p class="small opacity-75">
        Copyright © 2026 Mark Broadbent
        
    </p>
</div>

  </footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
