<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="https://tenbulls.co.uk/favicon.ico" />
<meta property="og:url" content="https://tenbulls.co.uk/posts/2011/02/15/automating-your-snapshots/">
  <meta property="og:site_name" content="tenbulls blog">
  <meta property="og:title" content="Automating your SQL snapshots">
  <meta property="og:description" content="A little while ago I was talking to someone about possibilities of reporting from SQL Server to avoid impacting the production server and the very first thing that sprang to mind was for them to use snapshotting from a mirror. They had already considered this option but it was not really viable because an almost real-time reporting solution was required. It wasnâ€™t until later that I wondered whether I had not really been precise enough in my explanation.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2011-02-15T16:49:00+01:00">
    <meta property="article:modified_time" content="2011-02-15T16:49:00+01:00">
    <meta property="article:tag" content="SQL">

<title>tenbulls blog | Automating your SQL snapshots</title>

      <link rel="stylesheet" href="/css/main.min.9c8fd37ab394163a75f3b9f19662b76ee3aa3538a20e35f5c0abe36f677c8302.css" integrity="sha256-nI/TerOUFjp187nxlmK3buOqNTiiDjX1wKvjb2d8gwI=" crossorigin="anonymous">
        <link rel="stylesheet" href="/css/palette/default.min.98db41a18eb278705557b678b4ad23b154f0f60e0dc69d3672f24207a951505b.css" integrity="sha256-mNtBoY6yeHBVV7Z4tK0jsVTw9g4Nxp02cvJCB6lRUFs=" crossorigin="anonymous">

      <script src="/js/main.86bb3d8e6f46df0fc97c2731e6b99175a13b87a4086acf578ff9b6992fcf32c1.js" integrity="sha256-hrs9jm9G3w/JfCcx5rmRdaE7h6QIas9Xj/m2mS/PMsE=" crossorigin="anonymous"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body
    class="dark"
>
  
  <main>
    
  <div class="container pt-5">
    <div class="row mt-5 pt-5">
      
  <nav aria-label="breadcrumb" class="small navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleMenu" aria-controls="collapsibleMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse mt-3 mt-md-0" id="collapsibleMenu">
      <ol class="breadcrumb fw-bold">
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/about"
        
      >about</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/"
        
      >home</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="https://www.meetup.com/hybrid-virtual-group/"
        
          target="_blank" rel="noopener noreferrer"
        
      >meetup</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/posts"
        class="text-decoration-underline link-offset-3"
        
      >posts</a>
      
    </li>
    <li class="breadcrumb-item my-1 my-md-0 ms-3 ms-md-0">
      <a href="/tags"
        
      >tags</a>
      
    </li>
      </ol>
    </div>
  </nav>

    </div>
    <div class="post">
      <header class="mb-4">
        <h1 class="text-uppercase">Automating your SQL snapshots</h1>
        
        
        <div aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item small">
              
              <time datetime="2011-02-15T16:49:00&#43;01:00">February 15, 2011</time>
            </li>
            
            
            <li class="breadcrumb-item small">
              3 minutes
            </li>
          </ol>
        </div>
      </header>
      
      <article>
        <p>A little while ago I was talking to someone about possibilities of reporting from SQL Server to avoid impacting the production server and the very first thing that sprang to mind was for them to use snapshotting from a mirror. They had already considered this option but it was not really viable because an almost real-time reporting solution was required. It wasn&rsquo;t until later that I wondered whether I had not really been precise enough in my explanation.</p>
<p>Since creating a snapshot can be pretty much instantaneous due to the way in which their mechanics work, as long as <em>real-time</em> means the time at any one instant, then there is no reason why snapshotting cannot be the solution for you. The only problem then that remains is how you are going to manage your snapshots, namely creation and destruction. Since the initial overhead of setting up (and then removing) a snapshot is relatively low, it makes perfect sense in my opinion to generate snapshots for reporting and then tear them down post report creation.</p>
<p>When you are creating a snapshot, since you must specify all datafile locations, auto-generation of them may at first seem a little more complicated than it really is. In truth, it is not particularly difficult and I have written some fairly useful code which can create a snapshot for you easily. Obviously you can customise the naming conventions of the snapshotted database to your requirements. Your reporting solution then could call a procedure to create the report snapshot (using the code below) on your mirrored database. All that would remain is to tear the snapshot down once the report has completed. I shall leave it to your imagination how you want to tear down your snapshots since depending upon your naming convention your method might differ slightly, but querying snapshots in existence is very simple as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>database_id sysname
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>database_id <span style="color:#f92672">=</span> DB_ID(<span style="color:#e6db74">&#39;Northwind&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> d.name,f.physical_name <span style="color:#66d9ef">FROM</span> sys.databases d <span style="color:#66d9ef">JOIN</span>
</span></span><span style="display:flex;"><span>sys.master_files f <span style="color:#66d9ef">ON</span> d.database_id<span style="color:#f92672">=</span>f.database_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> d.source_database_id <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>database_id
</span></span></code></pre></div><p>The procedure does however have an output parameter that returns the created snapshot name and you can use it in your reporting TSQL code to tear the snapshot down post report generation. Its up to you, but it is there if you want it!</p>
<p>We then move on to the main code itself to auto-generate your database mirror snapshot. The first thing you need to do is to decide which database you are going to deploy this stored procedure to. I personally prefer to have a dedicated database administration database that has all the custom written procedures, functions and the like housed in there. Once you have changed context into the database of choice your then need to execute the usp_createsnapshot creation script which can be found <a href="https://bit.ly/RXYajR">here</a> to deploy.</p>
<p>Once this procedure is deployed, all you need to do from now on in order to create a quick snapshot on any of your databases or mirrors located on this server is simply call the proc and pass in the name of the database or mirrored database and execute and hey presto a database snapshot has been created for you ðŸ™‚
Below I have entered a few examples of how the procedure works and it&rsquo;s error handling and feedback. The final example is valid input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.usp_createsnapshot <span style="color:#f92672">@</span>help<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.usp_createsnapshot master
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.usp_createsnapshot invaliddbname
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>ss sysname
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.usp_createsnapshot msdb,<span style="color:#f92672">@</span>ss <span style="color:#66d9ef">OUT</span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#e6db74">&#39;Snapshot &#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">@</span>ss <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; created.&#39;</span>
</span></span></code></pre></div><p>Within this following screenshot are the results, and in particular the output within the red box demonstrates the correct use of the stored procedure.</p>
<p><img src="/images/2011/snapshot_output.png" alt="Snapshot output"></p>
<p>Well that&rsquo;s the end of this post ladies and gentlemen. I hope you find this stored procedure as useful as I do, and remember&hellip; <em>happy reporting!</em></p>

      </article>
      
  <div class="tags pb-4 pt-2">
    
    
        <a class="badge rounded-pill text-uppercase text-bg-secondary" href="/tags/sql/">SQL</a>
  </div>

      <div class="row">
    <div class="col-md">
        
        <a href="https://tenbulls.co.uk/posts/2011/02/12/sqlbits-7-forgotten-photos-part-2/">
            <span>previous: </span>
            <span>SQLBits 7 the forgotten photos part 2</span>
        </a>
        
    </div>
    <div class="col-md text-md-end">
        
        <a href="https://tenbulls.co.uk/posts/2011/02/17/clusterin-nodes-on-different-subnets/">
            <span>next: </span>
            <span>Clustering nodes on different subnets</span>
        </a>
        
    </div>
</div>
      
    </div>
  </div>
  <footer>
    <div class="container mt-4 pb-1">
    <p class="small opacity-75">
        Copyright Â© 2026 Mark Broadbent
        
    </p>
</div>

  </footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
